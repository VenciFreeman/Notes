# 01_量化设计与分析基础

[toc]

## 引言

### 计算机飞速发展的四大效果

- 显著增强可供计算机用户使用的功能
- 性价比大幅提高，新型计算机出现
- 基于微处理器的计算机在整个计算机设计领域中占主导地位
  - 体系结构方面的创新
  - 技术改进的高效运用
- 对软件开发的影响
  - 以性能换取生产效率
  - 应用程序的本质也在变化

```
处理器性能的提高从单纯依赖指令级并行(ILP)转向数据级并行(DLP)和线程级并行(TLP)
```

## 计算机的分类

|       特征        |       关键的系统设计问题       |
| :---------------: | :----------------------------: |
|   个人移动设备    |  成本、能耗、媒体性能、响应率  |
|      台式机       |     性价比、能耗、图形性能     |
|      服务器       | 吞吐量、可用性、可扩展性、能耗 |
| 集群/仓库级计算机 |   性价比、吞吐量、能耗均衡性   |
|      嵌入式       |   价格、能耗、应用的特有性能   |

### 个人移动设备

> 带有多媒体用户界面的无线设备

- 概述
  - 成本是关键因素
  - 虽然强调能效，但散热较差，限制总功耗
  - 能耗与尺寸要求决定采用闪存而非磁盘
- 多媒体应用程序关键特性
  - 响应性能
  - 可预测性性能
- 应用程序的其他关键特性
  - 减少存储器占用
    - 重视存储器用量需要重视代码规模
  - 高效利用能量

### 台式机

- 价格与性能有更好的性价比
  - 性能：计算性能与图形性能

### 服务器

> 提供更大规模、更可靠的文件和计算服务，大规模企业计算的中枢

- 需求
  - 可靠性
    - 故障造成的损失非常严重
  - 可拓展性
    - 满足服务增长需求或功能增长需求
    - 计算容量、内存、存储器和I/O带宽的扩展能力
  - 高吞吐能力
    - 整体性能 (总体效率和成本效益)最为重要
    - 单位时间能够处理的请求数

### 集群/仓库级计算机

> 集群：一组桌面计算机或服务器通过局域网连接在一起，每个节点都运行自己的操作系统，节点间使用网络协议进行通信

- 性价比与功耗非常关键
- 仓库级计算机 (WSC)与服务器的相通之处在于都看重可靠性
  - 服务器
    - 可扩展性通过集成计算机硬件实现
  - WSC
    - 可扩展性通过连接计算机的局域网实现
- 仓库级计算机与超级计算机的相通之处在于昂贵
  - 超算
    - 强调浮点性能
    - 紧耦合性需要非常快速的内部网络
  - WSC
    - 重视互动应用程序
    - 需要大规模存储、可靠性和高带宽

### 嵌入式计算机

> 日用电器、网络交换机等中包含简单的嵌入式微处理器

- 能否运行第三方软件是区分嵌入式和非嵌入式计算机的分界线
- 处理能力和成本差别巨大
- 主要目标是以最低价格满足性能需要

### 并行度与并行体系结构的分类

- 主要约束条件：能耗和成本
- 应用程序中主要的并行
  - 数据级并行 (DLP)
    - 同时操作许多数据项
  - 任务级并行 (TLP)
    - 创建能够单独处理但大量采用并行方式执行的工作任务
- 开发应用并行的主要方式
  - 指令级并行
    - 在编译器的帮助下、利用流水线等思想开发数据级并行
    - 利用推理执行等思想开发中等水平的数据级并行
  - 向量体系结构与图形处理器
    - 将单条指令并行应用于数据级，以开发数据级并行
  - 线程级并行
    - 在紧耦合硬件模型中开发数据级并行或任务型并行
    - 允许在并行线程之间进行交互
  - 请求级并行
    - 在手动或操作系统指定的大量去耦合任务之间开发并行
- 按照多处理器最受约束组件中指令流和数据流并行区分计算机
  - 单指令流、单数据流 (SISD)
    - 单处理器，看作标准顺序计算机
  - 单指令流、多数据流 (SIMD)
    - 同一指令由多个使用不同数据流的处理器执行
    - 每个处理器都有自己的数据存储器，但只有一个指令存储器和控制处理器
  - 多指令流、单数据流 (MISD)
  - 多指令流、多数据流 (MIMD)
    - 针对任务级并行，每个处理器都提取自己的指令、对自己的数据进行操作
    - 比SIMD更灵活，适用性也更强，但开销更高

## 计算机体系结构的定义

### 指令集体系结构

> 指令集体系结构 (ISA)指代程序员可以看到的实际指令集，作用是区分软件和硬件的界限

#### ISA分类

> 几乎均划分到通用寄存器体系结构中

- 寄存器-存储器ISA：在许多指令中访问存储器
  - 80x86：16个通用寄存器和16个通常存入浮点数据的寄存器
- 载入-存储ISA：只能通过载入或存储指令访问存储器
  - MIPS：32个通用寄存器和32个浮点寄存器

#### 寻址

> 几乎所有桌面计算机和服务器计算机都使用字节寻址来访问存储器操作数
>
> 操作数对齐、访问速度更快

##### 寻址模式

- 寄存器寻址
- 立即数寻址
  - 用于常数寻址
- 位移量寻址
  - 无寄存器 (绝对数)
  - 两个寄存器 (用位移量 基址寻址)
  - 两个寄存器 (一个寄存器内容乘以操作数的字节大小，用比例索引和位移量进行变址寻址)
    - 减去位移量字段再加上寄存器间接寻址、基址寻址和变址寻址

#### 操作数的类型和大小

- 8位 (ASCII)
- 16位 (Unicode或半个字)
- 32位 (整数或字)
- 64位 (双字或长整型)
- 32位 (单精度)和64位 (双精度)的IEEE 754浮点数
- 80位浮点 (扩展双精度，80x86支持)

#### 操作指令和控制流指令

- 常见操作类别
  - 数据传输指令
  - 算术逻辑指令
  - 控制指令
  - 浮点指令
- 控制流指令：均使用相对于PC的寻址方式
  - 条件转移
    - MIPS条件分支检查寄存器中的内容
    - 80x86和ARM分支测试条件代码位
      - 在执行算术、逻辑运算时置位
  - 无条件跳转
    - ARM和MIPS过程调用将返回地址放在一个寄存器中
    - 80x86调用将返回地址放在存储器中的一个栈内
  - 过程调用和返回

#### ISA编码

- 两种基本的编码选择
  - 固定长度
    - ARM和MIPS指令均为32位，简化指令译码
      - 后来支持扩展，支持长16位的指令以便缩小程序规模 (Thumb, Thumb-2, MIPS16)
  - 可变长度
    - 80x86为可变长度，变化范围为1-18个字节，占用较少的空间
- 编码选择会影响将指令转换为二进制编码的方式

### 满足目标和功能需求的组成和硬件

- 组成：计算机设计的高阶内容
  - 存储器系统
  - 存储器互连
  - 内部处理器/CPU
- 硬件：
  - 计算机的具体实现
    - 包括详尽的逻辑设计和封装技术

|          功能需求          |                   应当具备或支持的典型特性                   |
| :------------------------: | :----------------------------------------------------------: |
|        **应用领域**        |                       **计算机的目标**                       |
|        个人移动设备        |   一系列任务的实时性能，包括图形、视频和音频交互性能；能效   |
|           台式机           |   一系列任务的实时性能，包括图形、视频和音频交互性能；能效   |
|           服务器           |   支持数据库和事务处理，可靠性和可用性的增强，支持可伸缩性   |
|     集群/仓库级计算机      |       独立任务的吞吐量性能，存储器的纠错功能，能耗均衡       |
|         嵌入式计算         | 通常需要对图形或视频提供技术支持，可能需要功耗限制和电源控制，实时约束 |
|      **软件兼容级别**      |                 **决定计算机的现有软件数目**                 |
|        编程语言级别        |                对于设计最为灵活，需要新编译器                |
| 目标代码或二进制代码兼容性 | 指令集体系结构完全确定，几乎无灵活性，但不需要在软件或端口程序中进行投入 |
|      **操作系统需求**      |               **支持选定操作系统所需要的特性**               |
|       地址空间的大小       |                   重要特性，可能会限制应用                   |
|         存储器管理         |            目前操作系统所必需，可能进行分页或分段            |
|            保护            |         不同的操作系统和应用需要：分页或分段，虚拟机         |
|          **标准**          |                    市场可能要求特定的标准                    |
|            浮点            |  格式和算法：IEEE 754标准，用于图形处理或信号处理的特殊算法  |
|          I/O接口           |       对于I/O设备：串行ATA，串行连接SCSI，PCI Express        |
|          操作系统          |               UNIX，Windows，Linux，CISCO IOS                |
|            网络            |               支持不同网络：以太网、InfiniBand               |
|          编程语言          |         语言 (ANSI C, C++, Java, Fortran)影响指令集          |

## 技术趋势

> 急剧变化的计算机技术
>
> - 集成电路逻辑技术
> - DRAM
> - 半导体闪存 (电可擦编程只读存储器)
> - 磁盘技术
> - 网络技术

### 性能趋势：带宽发展胜过延迟

- 带宽和吞吐量：在给定时间内完成的总工作量
- 延迟或响应时间：时间从开始到完成所经历的时间

### 晶体管性能与连线的发展

- 集成电路制造工艺用特征尺寸来衡量
  - 特征尺寸：一个晶体管或一条连线在x方向或y方向的最小尺寸
- 当特征尺寸线性下降时，晶体管密度平方上升
  - 晶体管性能的提高与特征尺寸的下降呈线性关系
- 连线延迟的改进较小，是大型集成电路的主要设计限制

## 集成电路功率和能耗趋势

> 功率是最大挑战
>
> - 必须将功率引入芯片并进行分配
> - 功率以热的形式耗散，必须消除

### 系统观点

#### 三个主要关注事项

- 处理器需要的最大功率
  - 所需功率大于电源能提供的功率会导致电压下降，从而导致器件无法正常工作
  - 现代处理器在峰值电流时功耗变化范围很大，因此提供了电压指数方法，允许减缓速度在更大幅度内调整电压 (会降低性能)
- 持续功耗：热设计功耗(TDP)决定冷却需求
  - TDP不是峰值功率 (峰值功率通常高1.5倍)
  - 不是给定计算期间消耗的实际平均功率
  - 现代处理器帮助管理热量的两项功能
    - 温度接近节点温度上限时降低时钟频率从而减小功率
    - 如果不成功，则启用第二热过载启动装置以降低功率
- 能耗和能耗效率

### 微处理器内部的能耗和功率

- CMOS芯片传统的主要能耗源是开关晶体管，也即动态功耗

$$
能耗_{动态}\propto 容性负载\times 电压^2\\
功率_{动态}\propto 1/2\times 容性负载\times 电压^2\times 开关频率
$$

- 降低时钟频率可以大幅降低动态功率，但不能降低能耗
- 降低电压可以大幅降低动态功率和能耗
- 容性负载的大小取决于输出端连接的晶体管数目及所用技术，这种技术决定了连线和晶体管的电容
- 从一种制造工艺转向另一种工艺时，晶体管的开关次数以及其开关频率的增高强于负载电容和电压的下降
  - 如果不能降低电压或提高每个芯片的功率，就需要减缓时钟频率的 增长速度
- 现代微处理器在保持时钟频率和电源电压不变的情况下提高能耗效率的的方法
  - 关闭非活动模块时钟以节省能耗和动态功率
  - 动态电压-频率调整 (DVFS)
  - 针对典型情景的设计
  - 超频，在少数几个核心上以较高时钟频率短时运行，直到温度开始上升为止
    - 超频频率大约比标称时钟频率高10%

- 由于晶体管处于截至状态时也存在漏电流，因此静态功率也是一个重要问题
  - 增大晶体管数目，即使空闲状态也会增加功率
  - 晶体管尺寸较小时，处理器中泄漏电流会增大

$$
功率_{静态}\propto 电流_{静态}\times 电压
$$

- 竞相暂停：使用一个速度较快但能耗效率较低的处理器，使系统其他部分进入睡眠模式，有助于降低整体功耗

## 成本趋势

### 时间、产量和大众化的影响

- 推动成本走低的基础原理：学习曲线
  - 制造成本随时间的推移而降低
  - 学习曲线根据<u>成品率</u>的变化测得
    - 成品率：成功通过测试程序的器件占所生产器件总数的百分比
- 产量是决定成本的重要因素之一
  - 产量的提高缩短降低学习曲线所需的时间
    - 时间在一定程度上与系统 (或芯片)的制造数量成正比例关系
  - 产量的增加会提高购买与制造效率，所以产量会降低成本
  - 产量的增加还降低必须分摊到每台计算机上的开发成本

### 集成电路成本

$$
集成电路成本=\frac{晶片成本+晶片测试成本+封装与最终测试成本}{最终测试成品率}\\
晶片成本=\frac{晶圆成本}{每个晶圆上的晶片数\times 晶片成品率}\\
每个晶圆上的晶片数=\frac{\pi\times(晶圆直径)/2^2}{晶片面积}-\frac{\pi\times晶圆直径}{\sqrt{2\times 晶片面积}}
$$

- 每个晶圆上晶片数计算公式
  - 第一项：晶圆面积与晶片面积之比
  - 第二项：“方枘圆凿”问题
- 芯片成本
  - 制造工艺决定晶圆成本、晶片成品率和单位面积上的缺陷数
  - 只能控制晶片面积

### 成本与价格

- 大多数公司研发费用只占收入的4% (大众化PC业务)至12% (高端服务器业务)

### 制造成本与运行成本

- 服务器和网络的可分摊购买价格略高于仓库级计算机月运行成本的60%
- 月运行成本大约30%是电费以及配电和冷却的可分摊基础设施

## 可信任度

> 基础设施供应商提供服务等级协议 (SLA)或服务等级目标 (SLO)，保证网络或电源服务是可靠的

- 系统在SLA规定的两种服务状态之间切换

  - 服务实现：提供指定服务

  - 服务中断：所提供服务与SLA不一致

    - 转换由故障或恢复导致，对这两种状态进行量化，可以得到可信任度的两种主要度量

  - 模块可靠性

    - 平均无故障时间 (MTTF)：从参考初始时刻开始持续实现服务的可靠性度量
    - 平均修复时间 (MTTR)：服务中断的度量
    - 平均故障间隔时间 (MTBF)：MTTF+MTTR

  - 模块可用性

    - 服务完成于服务中断两种状态之间切换时，对服务完成的度量
    - 对于可修复的非冗余系统，模块可用性为

    $$
    模块可用性=\frac{MTTF}{MTTF+MTTR}
    $$

- 应对故障的主要方法是冗余

  - 时间冗余：重复操作以查看是否仍然错误
  - 资源冗余：当一个组件故障时，由其他组件接管

## 性能的测量、报告和汇总

$$
n=\frac{执行时间Y}{执行时间X}=\frac{性能X}{性能Y}
$$

- 最直接的时间定义：挂钟时间，响应时间或已用时间

### 基准测试

### 报告性能测试结果

### 性能结果汇总

## 计算机的量化原理

### 充分利用并行

### 局域性原理

### 重点关注常见情形

### Amdahl定律

### 处理器性能公式

## 性能、价格和功耗

## 谬论与易犯错误