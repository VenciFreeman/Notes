# 第一章 引言

[TOC]

## 什么是操作系统

- 负责管理计算机的所有资源并提供一个可在其上编写应用程序的平台
- 本书模型：MINIX 3

### 操作系统的定位

- 应用程序
  - 信息系统、Web浏览器：解决特定问题的应用软件
- 系统程序
  - 编译器、编辑器、命令解释器(用户态)
  - **操作系统**(内核态/管态)：将硬件复杂性封装起来，提供更方便的编程接口
- 硬件
  - 机器语言：指令集体系结构(ISA)
  - 微体系结构：物理设备组织成功能单元
  - 物理设备：集成电路芯片、线路、电源、阴极射线管等

### 两大功能

#### 作为扩展机(自顶向下)

- 提供等价的扩展计算机，或称虚拟机，比底层硬件更容易编程

#### 作为资源管理器(自底向上)

- 在相互竞争的程序之间有序控制硬件设备的分配
  - 时间上资源共享：串行轮流使用资源
  - 空间上资源共享：划分资源后分配给各个程序

## 操作系统的发展历史

### 第一代：1945-1955

- 机械继电器到真空管
- 插接板硬接线到穿孔卡片
- 处理数值计算问题，如函数表

### 第二代：1955-1965

- 晶体管
- 批处理：小机器输入输出，大机器计算
- 典型作业结构：
  - $JOB标识最大运行时间等信息
  - $FORTRAN通知从系统磁带装入Fortran编译器
  - $LOAD通知装入编译好的目标程序
  - $RUN通知运行
  - $END标识作业的结束
- 处理科学和工程计算，如偏微分方程求解

### 第三代：1965-1980

- 集成电路
- 尝试统一计算机体系结构(System/360)
- 多道程序：内存分区作业
- 假脱机技术(SPOOLING)加快输入输出
- 分时系统：多个终端，快速交互式服务
- 小型机崛起，UNIX

### 第四代：(1980-)

- 个人计算机
- 微处理器
- DOS，GUI
- 网络操作系统，分布式操作系统

## 操作系统概念

### 进程

#### 概念

- 正在执行的程序
- 每个进程都有自己的地址空间，即一组内存地址，中间包含可执行程序、数据和栈
- 与进程相关的还包括一组寄存器、及运行程序所需的其他信息

#### 进程表

- 进程的所有信息存在表中(实际上是一个结构数组/链表)
  - 进程的地址空间，称为内核映像(core image)，负责从终端读入命令
  - 相应进程表项，包括寄存器值及其他信息
- 方便挂起的进程重新运行

#### 其他

- 与进程管理有关的系统调用中，最主要的是进程的创建与终止
- 一组相关进程相互通信协调各自进展共同完成某项任务，这种通信称为进程间通信

### 文件

#### 概念

- 操作系统的一个主要功能中包括屏蔽磁盘和其他硬件细节，提供一个简洁方便且与设备无关的文件模型
- 目录：存放文件，得到一个层次化的模型，即文件系统
- 进程和文件都组织成树状结构(但差别很大)
  - 进程
    - 进程树不会很深，很少超过三层
    - 进程间层次结构是暂时性的
    - 只有父进程可以访问和控制子进程
  - 文件
    - 文件树一般在四五层甚至个更多
    - 层次结构长期存在
    - 文件和目录对所有者和其他用户均可访问

#### 其他概念

- 路径名：包含从根目录到文件的所有中间目录
- rwx位：3*3bit的保护码域，分别描述文件所有者，同组用户和其他用户，每个域每bit分别标识读写和执行权限。对目录来说，x表示搜索权限
- 文件描述符(file descriptor)：打开文件前系统访问权限检查的返回值，为-1时表示访问权限不够
- 挂装(mount)：将可移动介质上文件系统挂装到硬盘上根文件系统，类似树的合并
- 设备文件(special file)：目的是使I/O设备使用起来更类似于文件
  - 块设备文件：以随机访问的数据块为单元的设备
  - 字符设备文件：以字符流方式进行操作的设备，如打印机
- 管道：连接两个进程的虚拟文件

### 命令解释器

- MINIX 3：shell
- 系统提示符：如$，>>等，提示输入

## 系统调用

- 任何单CPU计算机一次只能执行一条指令
- 发出一个系统调用类似于发出一个特殊的函数调用

### 示例：read

#### 三个参数

- 指定所访问文件
- 指定所用缓冲区
- 指定要读取的字节数

#### C语言调用

```c
	count = read(fd, buffer, nbytes);
```

- 正常情形下count = nbytes
- 访问错误时count置为-1，同时把错误码放在全局变量errno中

#### 调用分类

- MINIX 3有6类共53条系统调用，除此之外还有少量的专用系统调用
  - 进程管理
  - 信号
  - 文件管理
  - 目录及文件系统管理
  - 保护
  - 时间管理

### 进程/信号/文件/目录/保护管理的系统调用 (可略)

#### 相关系统调用

- `creat` 
  - 功能：创建一个新文件
  - 参数：文件名和保护模式
- `open`
  - 功能：打开一个文件
  - 参数：文件路径名和打开方式
    - 打开方式：只读、只写或可读可写
- `read` / `write`
  - 功能：读/写文件
  - 参数：所访问文件，所用的缓冲区和要读/写的字节数
- `lseek`
  - 功能：直接修改文件指针位置 (随后`read`/`write`可在文件任意位置读写)
  - 参数：文件描述符，文件的位置和指明文件位置相对于文件开头、当前位置或结尾
  - 返回值：文件指针修改后的绝对位置
- `stat` / `fstat`
  - 功能：获取文件信息 (类型<普通文件、设备文件、目录，etc.>、大小、最后修改时间)
  - 参数：文件名/文件描述符，指向存放文件信息的数据结构的指针
- `dup` / `dup2`
  - 功能：操作文件描述符/讲未使用的文件描述符定向到已打开文件
  - 参数：文件描述符/+已打开文件
  - 返回值：最小的可用文件描述符
- `pipe`
  - 功能：创建管道用于读写
  - 参数：两个文件描述符，分别存放读写操作
- `ioctl`
  - 参数：指定文件、指定操作类型，制定POSIX数据结构的地址
- `access`
  - 功能：检查文件访问操作是否有权限
- `rename`
  - 功能：重命名
- `fcntl`
  - 功能：对文件进行控制 (加锁解锁和检测)

#### 终端模式

##### 传统

- 熟模式 (cooked)
  - 最常用
  - 该模式下字符的删除和终止可以正常工作
  - `Ctrl`+`S/Q`表示停止和恢复终端输出
  - `Ctrl`+`D`表示文件结束
  - `Ctrl`+`C`产生中断信号
  - `Ctrl`+`\`产生退出信号并强制进行内核映像转储
- 生模式 (raw)
  - 适合全屏幕编辑器
  - 取消熟模式下的功能，任何输入字符都会不经处理立即发送给程序
- cbreak
  - 介于上述两种模式之间
  - 删除，终止和结束被禁用，其他组合键有效

##### POSIX

-  正规模式
  - 对应于熟模式
  - 定义11个特殊字符，输入以行为单位进行

- 非正规模式
  - 字符读操作以可接受最小字符个数和指定时间共同决定

## 操作系统结构

### 整体结构

- 实际上是”无结构“

`Page 31`

### 分层结构

### 虚拟机

### 外核

### 客户-服务器结构

## 总结