# SoC简介

[TOC]

## SoC与IP简介

### SoC特征

- SoC指**单片系统**，因此一般具有主控CPU，运行软件 (操作系统)
  - 换句话讲SoC是一个单片集成的完成用户专用功能的单片系统
- 类似计算机，SoC具有**自己的组成结构和体系构架**
  - 传统的SoC一般采用总线构架
    - 组成除CPU、存储器外，还有完成用户专用功能的硬件 、外设接口/存储接口
- SoC具有**平台化特征**，即体系结构一旦固化，会连续应用在后续系列化产品中
  - 基于相同平台的新产品可采用新工艺、增加新的扩展功能/部件
- SoC具有**标准化特征**，即体系构架采用标准化的总线，符合标准的部件很方便集成
  - 来自自身或第三方、符合SoC平台接口要求、可以被不同SoC产品采用的模块称为IP核

### IP核

- IP是指知识产权，意味着IP核是受产权保护的、具有经济价值的
- 现在SoC芯片规模达数亿到数十亿晶体管，研制周期最多1-2年
  - 这样大规模的芯片设计不可能从零开始，一般会大量使用成熟的部件做集成，这些部件既有自身积累，也有向供应商采购
  - 有统计称一个新产品从零做起的电路不超过10%
- 为了方便IP核被各类SoC使用，它应该是标准化/完整的/正确的
  - 标准化指使用这个IP的设计流程是通用的、IP的接口是规范的
  - 完整的指IP核除设计说明和代码外，还应包括网表、版图、仿真信息、脚本文件等，方便使用者做各种集成、设计、验证工作
  - 正确的指一般IP核都经过充分验证，没有错误
- IP核交付项和IP核供应商

## 存储组织

### 带宽和延迟难题

#### 存储器层级

<img src="C:..\fig\ME04\ME04_chapter05_fig01.jpg" style="zoom:80%;" />

\* RF：寄存器堆

- 容量：寄存器 << SRAM << DRAM
- 延迟：寄存器 << SRAM << DRAM
- 带宽：on-chip >> off-chip
- 在一次数据访问中

#### 在一次数据访问中

- 如果数据 $\in$ 快速存储 $\Longrightarrow$ 低延迟访问 (SRAM)
- 如果数据 $\notin$ 快速存储 $\Longrightarrow$ 高延迟访问 (DRAM)

#### CPU和外接存储器的带宽差异

##### 处理器DRAM间隙 (延迟)

<img src="C:..\fig\ME04\ME04_chapter05_fig02.jpg" style="zoom:80%;" />

- 4发射的3 GHz超标量访问100 ns DRAM可以在一次内存访问期间执行1200条指令

### 层次化量化分析

- 计算机系统中最重要的关系是运算单元和存储器的关系
- 运算单元按照GHz运行，需要的数据带宽将是若干GByte/s，容量将是GByte量级
  - 片上SRAM存储器带宽一般只有10~50%
  - 片外DRAM存储器带宽一般只有0.1~1%
  - 片上容量一般只有MB量级，片外容量GB量级
- 提速靠内部小型化存储器，扩容靠外部大容量存储器，形成层次化存储组织结构
- 寄存器堆 (多端口SRAM)：带宽和运算单元匹配，但容量很小，存放当前指令运行需要的数据
- 片上SRAM存储器 (高速缓存Cache)：多模块方式，存放当前程序运行需要处理的数据
- 外部DRAM/Flash存储器：存放所有数据

#### 计算机系统的层次化存储结构

<img src="C:..\fig\ME04\ME04_chapter05_fig03.jpg" style="zoom:80%;" />

#### 存储器组织案例

> Itanium-2 On-Chip缓存 (Intel/HP, 2002)

<img src="C:..\fig\ME04\ME04_chapter05_fig04.jpg" style="zoom:80%;" />

- 第一级：16 KB, 4-way s.a., 64 B line, quad-port (2 load+2 store)，单周期延迟 
- 第二级：64 KB, 4-way s.a., 128 B line, quad-port (4 load+4 store)，5周期延迟 
- 第三级：3 MB, 12-way s.a., 128 B line, single 32B-port，12周期延迟 

## 存储器管理机制：DMA

### 概述

>Direct Memory Access, 直接存储访问

- 在程序运行过程中，经常需要进行大段数据输入/输出 (与外部大容量存储器之间大量数据传输)
  - 由CPU掌管得不偿失
  - 采用程序直接传送，主机工作效率受到限制
  - 采用中断控制数据传送会使主机处于频繁的中断与返回过程中，这样降低了CPU的性能，还有丢失数据的可能
- DMA实现直接数据通路控制，主要用于高速I/O设备 (DRAM端口)与片上存储之间成组数据传送
  - 数据传送时是在DMA控制器控制下进行的 ，由DMA控制器给出当前正在传送数据字的地址，并统计传送数据的个数以确定一组数据的传送是否已结束
  - 在数据传送之前和结束后要通过程序或中断方式对缓冲器和DMA控制器进行预处理和后处理
-  DMA工作过程中，CPU可以暂停，或利用其它资源工作

### DMA控制器

- DMA控制器包括多个设备寄存器、中断控制和DMA控制逻辑等
- 主要的寄存器有
  - 主存地址寄存器 (AR)：存放要交换数据的主存地址
  - 外围设备地址寄存器 (ADR)：存放I/O设备的设备码，或者表示设备信息存储区的寻址信息
  - 字数计数器 (WC)：对传送数据的总字数进行统计
  - 控制与状态寄存器 (CSR)：用来存放控制字和状态字
  - 数据缓冲寄存器 (DBR)：暂存每次传送的数据

#### 工作过程

- 在DMA方式中，当I/O设备需要进行数据传送时，通过DMA控制器 (DMA接口)向CPU提出DMA传送请求，CPU响应之后将让出系统总线，由DMA控制器接管总线进行数据传送。主要功能有
  - 传送前
    - 接收外设发出的DMA请求，并向CPU发出总线请求
    - CPU响应此总线请求，发出总线响应型号，接管总线控制权，进入DMA操作周期
  - 传送时
    - 确定传送数据的主存单元地址及长度，并能自动修改主存地址计数器和传送长度计数
    - 规定数据在主存和外设间的传送方向，发出读写等控制信号，执行数据传送操作
  - 传送后
    - 向CPU报告DMA操作的结束

#### DMA传送过程

<img src="C:..\fig\ME04\ME04_chapter05_fig06.jpg" style="zoom:80%;" />

### DMA在系统中的位置

<img src="C:..\fig\ME04\ME04_chapter05_fig05.jpg" style="zoom:80%;" />

|      模块      |                             介绍                             |
| :------------: | :----------------------------------------------------------: |
|    中断机构    |    当一个数据块传送完毕后触发中断机构，向CPU提出中断请求     |
| 控制/状态逻辑  | 由控制和时序电路及状态标志组成，用于指定传送方向，修改传送参数，并对DMA请求信号和CPU响应信号进行协调和同步 |
| DMA请求触发器  | 每当I/O设备准备好数据后给出一个控制信号，使DMA请求触发器置位 |
| 主存地址计数器 |               简称AR，存放要交换数据的主存地址               |
| 传送长度计数器 | 简称WC，用来记录传送数据的长度，计数溢出时，数据即传送完毕，自动发中断请求信号 |
| 数据缓冲寄存器 |                    用于暂存每次传送的数据                    |

```
在DMA传送过程中，DMA控制器将接管CPU的地址总线、数据总线和控制总线，CPU的主存控制信号被禁止使用。而当DMA传送结束后，将恢复CPU的一切权利并开始执行其他操作
```

### DMA和CPU交替工作模式

- 主存和DMA控制器之间有一条数据通路，因此主存和I/O设备之间交换信息时，不通过CPU
- 但当I/O设备和CPU同时访问主存时，可能发生冲突
- 为了有效地使用主存，DMA控制器与CPU通常采用以下三种方式访问主存
  - 停止CPU访问主存
    - 控制简单
    - CPU处于不工作状态或保持状态
    - 未充分发挥CPU对主存的利用率
  - DMA与CPU交替访存
    - 不需要总线使用权的申请、建立和归还过程
    - 硬件逻辑更为复杂
  - 周期挪用 (存取周期窃取)
- DMA访存主要存有三种可能
  - CPU此时不访存 (不冲突)
  - CPU正在访存 (存取周期结束后让出总线)
  - CPU与DMA同时请求访存 (I/O访存优先)

<img src="C:..\fig\ME04\ME04_chapter05_fig07.jpg" style="zoom:80%;" />

## 总线的作用

### 存储和总线系统

<img src="C:..\fig\ME04\ME04_chapter05_fig08.jpg" style="zoom:80%;" />

<img src="C:..\fig\ME04\ME04_chapter05_fig09.jpg" style="zoom:80%;" />

## I/O接口简介

### 接口的作用

> 没有I/O的计算机无用
>
> 随着时间的流逝，实际上有成千上万种计算机I/O

### 分类

- 二级/三级存储 (闪存/磁盘/磁带)
- 网络 (以太网，WiFi，蓝牙，LTE)

- 人机界面 (键盘，鼠标，触摸屏，图形，音频，视频，神经等)
- 打印机 (行式，激光，喷墨，照片，3D等)
- 传感器 (过程控制，GPS，心率等)

- 执行器 (阀门，机器人，汽车制动器等)
- I/O设备的混合高度依赖于应用程序

### 接口访问方式

> 两种一般策略

- 内存映射
  - I/O设备显示为处理器的内存位置
  - 对I/O设备位置的读写可配置I/O和传输数据 (使用已编程的I/O或DMA)
- I/O通道
  - 体系结构指定命令以在定义的通道上执行I/O命令
  - I/O通道结构可以在内存映射的设备结构上分层
- 除了数据传输外，还必须定义同步方法
  - 轮询：CPU检查状态位
  - 中断：设备在发生事件时中断CPU

### 接口如何接入处理器系统

#### 简单案例

<img src="C:..\fig\ME04\ME04_chapter05_fig10.jpg" style="zoom:80%;" />

- 某些范围的物理地址映射到I/O总线设备
- I/O桥减少了关键CPU-DRAM总线上的电气负载
- 设备可以是“从属”，仅响应I/O总线请求
- 设备可以是“主设备”，启动I/O总线传输

#### 复杂案例

<img src="C:..\fig\ME04\ME04_chapter05_fig11.jpg" style="zoom:80%;" />

- I/O连接速度与设备需求相匹配
  - 图形的特殊直接连接
  - 用于磁盘驱动器，以太网的快速I/O总线
  - 键盘，鼠标，触摸屏的慢速I/O总线
    - 减少快速I/O总线上的负载 + 减少设备所需的总线逻辑

### 接口通信协议种类

- 通用端口 (GPIO)：可编程的输入/输出
- PCI/PCI-E：计算机系统常用总线
- 通用高速串行接口：
  - USB：众多应用设备的连接
  - SerDes、LVDS：与相同接口的其它芯片互连
- 低速串行接口：支持主芯片和从芯片串行通信
  - SPI：串行外设接口
  - I2C总线：异步芯片间互连
  - UART：通用异步收发器
- PWM：脉冲宽度调制，产生各种脉冲波形，在控制和测量系统时应用
- 其它：看门狗 (WDT)、实时时钟 (RTC)、电源管理 (PMU)

### 增加I/O的系统

- <img src="C:..\fig\ME04\ME04_chapter05_fig12.jpg" style="zoom:80%;" />

## 总线案例：AMBA

### AMBA简介

- 众多的CPU、存储器、IP核、IO设备如何连接：
  - 两两互连不现实
  - 总线是最经典、也是目前应用最广的互连方式
  - 目前还有Crossbar、Mech网、NoC等
  - AMBA总线是ARM公司制定的SoC总线标准，在基于ARM处理器的SoC设计中广为采用，成为行业事实的SoC总线标准
    - 包括AHB、APB、ASB、AXI等总线类型，总线/总线间通过桥接互连
  - AHB总线用于高性能模块，为处理器、片上存储、外接存储、DMA、高性能IP和其它高速接口提供互连
  - APB总线用于为慢速外设提供总线技术支持，是一种优化的，低功耗的，精简接口总线
  - AXI是AMBA3.0版新增的高速、多通道总线

### 案例

<img src="C:..\fig\ME04\ME04_chapter05_fig13.jpg" style="zoom:80%;" />

<img src="C:..\fig\ME04\ME04_chapter05_fig14.jpg" style="zoom:80%;" />

### AMBA的AHB总线

- 特性
  - 突发连续传输，分步传输
  - 支持多个主控制器、单周期内主控制器处理,单时钟边沿操作
  - 支持64位，128位总线；支持字节，半字节和字的传输
- AHB总线通常设计时包含以下几个设备
  - AHB主控制器
    - 主控制器可以通过地址和控制信息，可以进行初始化，读，写操作
    - 在同一时间，总线上只能有一个主控制器
  - AHB从设备
    - 从设备通常是指在其地址空间内响应主控制器发出的读写控制操作的被动设备
  - AHB仲裁器
    - 仲裁器根据用户的配置，确保在总线上同一时间只有一个主控制器拥有总线控制权限
    - AHB总线上只能有一个仲裁器。
  - AHB译码器
    - 译码器解析在总线上传输的地址和控制信息
    - AHB总线上只能有一个译码器