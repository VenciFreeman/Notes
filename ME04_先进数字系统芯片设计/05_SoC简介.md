# SoC简介

[TOC]

## SoC与IP简介

### SoC特征

- SoC指**单片系统**，因此一般具有主控CPU，运行软件 (操作系统)
  - 换句话讲SoC是一个单片集成的完成用户专用功能的单片系统
- 类似计算机，SoC具有**自己的组成结构和体系构架**
  - 传统的SoC一般采用总线构架
    - 组成除CPU、存储器外，还有完成用户专用功能的硬件 、外设接口/存储接口
- SoC具有**平台化特征**，即体系结构一旦固化，会连续应用在后续系列化产品中
  - 基于相同平台的新产品可采用新工艺、增加新的扩展功能/部件
- SoC具有**标准化特征**，即体系构架采用标准化的总线，符合标准的部件很方便集成
  - 来自自身或第三方、符合SoC平台接口要求、可以被不同SoC产品采用的模块称为IP核

### IP核

- IP是指知识产权，意味着IP核是受产权保护的、具有经济价值的
- 现在SoC芯片规模达数亿到数十亿晶体管，研制周期最多1-2年
  - 这样大规模的芯片设计不可能从零开始，一般会大量使用成熟的部件做集成，这些部件既有自身积累，也有向供应商采购
  - 有统计称一个新产品从零做起的电路不超过10%
- 为了方便IP核被各类SoC使用，它应该是标准化/完整的/正确的
  - 标准化指使用这个IP的设计流程是通用的、IP的接口是规范的
  - 完整的指IP核除设计说明和代码外，还应包括网表、版图、仿真信息、脚本文件等，方便使用者做各种集成、设计、验证工作
  - 正确的指一般IP核都经过充分验证，没有错误
- IP核交付项和IP核供应商

## 存储组织

### 带宽和延迟难题

#### 存储器层级

<img src="C:..\fig\ME04\ME04_chapter05_fig01.jpg" style="zoom:80%;" />

- 容量：寄存器 << SRAM << DRAM
- 延迟：寄存器 << SRAM << DRAM
- 带宽：on-chip >> off-chip
- 在一次数据访问中

#### 在一次数据访问中

- 如果数据 $\in$ 快速存储 $\Longrightarrow$ 低延迟访问 (SRAM)
- 如果数据 $\notin$ 快速存储 $\Longrightarrow$ 高延迟访问 (DRAM)

#### CPU和外接存储器的带宽差异

##### 处理器DRAM间隙 (延迟)

<img src="C:..\fig\ME04\ME04_chapter05_fig02.jpg" style="zoom:80%;" />

- 4发射的3 GHz超标量访问100 ns DRAM可以在一次内存访问期间执行1200条指令

### 层次化量化分析

- 计算机系统中最重要的关系是运算单元和存储器的关系
- 运算单元按照GHz运行，需要的数据带宽将是若干GByte/s，容量将是GByte量级
  - 片上SRAM存储器带宽一般只有10~50%
  - 片外DRAM存储器带宽一般只有0.1~1%
  - 片上容量一般只有MB量级，片外容量GB量级
- 提速靠内部小型化存储器，扩容靠外部大容量存储器，形成层次化存储组织结构
- 寄存器堆 (多端口SRAM)：带宽和运算单元匹配，但容量很小，存放当前指令运行需要的数据
- 片上SRAM存储器 (高速缓存Cache)：多模块方式，存放当前程序运行需要处理的数据
- 外部DRAM/Flash存储器：存放所有数据

#### 计算机系统的层次化存储结构

<img src="C:..\fig\ME04\ME04_chapter05_fig03.jpg" style="zoom:80%;" />

#### 存储器组织案例

> Itanium-2 On-Chip缓存 (Intel/HP, 2002)

<img src="C:..\fig\ME04\ME04_chapter05_fig04.jpg" style="zoom:80%;" />

- 第一级：16 KB, 4-way s.a., 64 B line, quad-port (2 load+2 store)，单周期延迟 
- 第二级：64 KB, 4-way s.a., 128 B line, quad-port (4 load+4 store)，5周期延迟 
- 第三级：3 MB, 12-way s.a., 128 B line, single 32B-port，12周期延迟 

## 存储器管理机制：DMA

### 概述

>Direct Memory Access, 直接存储访问

- 在程序运行过程中，经常需要进行大段数据输入/输出 (与外部大容量存储器之间大量数据传输)
  - 由CPU掌管得不偿失
  - 采用程序直接传送，主机工作效率受到限制
  - 采用中断控制数据传送会使主机处于频繁的中断与返回过程中，这样降低了CPU的性能，还有丢失数据的可能
- DMA实现直接数据通路控制，主要用于高速I/O设备 (DRAM端口)与片上存储之间成组数据传送
  - 数据传送时是在DMA控制器控制下进行的 ，由DMA控制器给出当前正在传送数据字的地址，并统计传送数据的个数以确定一组数据的传送是否已结束
  - 在数据传送之前和结束后要通过程序或中断方式对缓冲器和DMA控制器进行预处理和后处理
-  DMA工作过程中，CPU可以暂停，或利用其它资源工作

### DMA控制器

- DMA控制器包括多个设备寄存器、中断控制和DMA控制逻辑等
- 主要的寄存器有
  - 主存地址寄存器 (AR)：存放要交换数据的主存地址
  - 外围设备地址寄存器 (ADR)：存放I/O设备的设备码，或者表示设备信息存储区的寻址信息
  - 字数计数器 (WC)：对传送数据的总字数进行统计
  - 控制与状态寄存器 (CSR)：用来存放控制字和状态字
  - 数据缓冲寄存器 (DBR)：暂存每次传送的数据

#### 工作过程

- 在DMA方式中，当I/O设备需要进行数据传送时，通过DMA控制器 (DMA接口)向CPU提出DMA传送请求，CPU响应之后将让出系统总线，由DMA控制器接管总线进行数据传送。主要功能有
  - 传送前
    - 接收外设发出的DMA请求，并向CPU发出总线请求
    - CPU响应此总线请求，发出总线响应型号，接管总线控制权，进入DMA操作周期
  - 传送时
    - 确定传送数据的主存单元地址及长度，并能自动修改主存地址计数器和传送长度计数
    - 规定数据在主存和外设间的传送方向，发出读写等控制信号，执行数据传送操作
  - 传送后
    - 向CPU报告DMA操作的结束

#### DMA传送过程

<img src="C:..\fig\ME04\ME04_chapter05_fig06.jpg" style="zoom:80%;" />

### DMA在系统中的位置

<img src="C:..\fig\ME04\ME04_chapter05_fig05.jpg" style="zoom:80%;" />

|      模块      |                             介绍                             |
| :------------: | :----------------------------------------------------------: |
|    中断机构    |    当一个数据块传送完毕后触发中断机构，向CPU提出中断请求     |
| 控制/状态逻辑  | 由控制和时序电路及状态标志组成，用于指定传送方向，修改传送参数，并对DMA请求信号和CPU响应信号进行协调和同步 |
| DMA请求触发器  | 每当I/O设备准备好数据后给出一个控制信号，使DMA请求触发器置位 |
| 主存地址计数器 |               简称AR，存放要交换数据的主存地址               |
| 传送长度计数器 | 简称WC，用来记录传送数据的长度，计数溢出时，数据即传送完毕，自动发中断请求信号 |
| 数据缓冲寄存器 |                    用于暂存每次传送的数据                    |

```
在DMA传送过程中，DMA控制器将接管CPU的地址总线、数据总线和控制总线，CPU的主存控制信号被禁止使用。而当DMA传送结束后，将恢复CPU的一切权利并开始执行其他操作
```

### DMA和CPU交替工作模式

- 主存和DMA控制器之间有一条数据通路，因此主存和I/O设备之间交换信息时，不通过CPU
- 但当I/O设备和CPU同时访问主存时，可能发生冲突
- 为了有效地使用主存，DMA控制器与CPU通常采用以下三种方式访问主存