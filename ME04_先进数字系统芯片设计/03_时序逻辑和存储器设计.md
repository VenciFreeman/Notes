# 时序逻辑和存储器设计

[TOC]

## 基本时序单元

### 基础

#### 时序定义

- 当前输出与当前输入以及当前状态有关，是时序逻辑 
  - 区分当前、之前与将来
  - 用时钟进行区分
- 当前输出只与当前输入有关，是组合逻辑
  - 时钟信号与控制信号进行与非，是组合逻辑

#### 基本单元

- 时间轴标定时间
- 存储单元记忆当前状态/之前输出
  - 动态存储单元：电容
    - 充放电
  - 静态存储单元：(偶数级)反向器环
    - 0与1在反向器环中反复转换，不会丢失
    - 奇数级反向器环会成为振荡器

#### 时钟作用

- 时钟同步电路的使用
  - 当前大部分设计都是同步逻辑

### 示例

#### RS触发器

<img src=" ../fig/ME04/ME04_chapter03_fig01.jpg" style="zoom:67%;" />

- 和级联反向器一样具有强制将输出设为0 (reset)或1 (set)的能力

<img src=" ../fig/ME04/ME04_chapter03_fig02.jpg" style="zoom:67%;" />

### CMOS逻辑中的基本时序单元

#### DL (D-latch)

> D锁存器

- 电平采样
  - 透明锁存
  - D锁存

<img src=" ../fig/ME04/ME04_chapter03_fig03.jpg" style="zoom:50%;" />

#### DFF (D-flip-flop)

> D主从触发器

- 边缘采样
  - 主从触发器
  - D触发器
  - D寄存器
- 触发器构建为成对的背对背锁存

<img src=" ../fig/ME04/ME04_chapter03_fig06.jpg" style="zoom:60%;" />

- 启用时将力输出设置为高
- 触发器具有异步置位和复位功能

<img src=" ../fig/ME04/ME04_chapter03_fig07.jpg" style="zoom:60%;" />

#### DFF with RS

- 三态反馈
  - 静态
  - 逆行风险
- 静态闩锁现在必不可少

<img src=" ../fig/ME04/ME04_chapter03_fig04.jpg" style="zoom:67%;" />

#### 其他电路实现形式

<img src=" ../fig/ME04/ME04_chapter03_fig05.jpg" style="zoom:67%;" />

## 时序收敛

### 时钟重要性

- FO4中的周期时间
- 每一代时钟周期越来越短

<img src=" ../fig/ME04/ME04_chapter03_fig08.jpg" style="zoom:60%;" />

### 时钟的历史

- 早期：单一时钟或多相位时钟，定制化选择时钟
- 晶体管数目达到百万以上：全同步逻辑
- 频率达到100 MHz以上：考虑Skew问题
- 晶体管数目达到千万以上：考虑插入时钟树
- 晶体管上亿/频率GHz以上：考虑多时钟域

### 术语定义

> - 时钟事件周围有一个时序“窗口”，在此期间输入必须保持稳定且不变才能被识别
>
> - 由于数据到达时间、时钟沿、建立保持时间都是一个区间，随PVT变化，时序问题变得复杂

<img src=" ../fig/ME04/ME04_chapter03_fig09.jpg" style="zoom:60%;" />

#### 时钟 (clock)

- 周期性事件，导致存储元件的状态改变
- 上升沿，下降沿，高电平，低电平

#### 建立时间 (tsu, setup time)

- 时钟事件发生之前输入必须稳定的最短时间

#### 保持时间 (th, hold time)

- 时钟事件之后输入必须保持稳定的最短时间

### 时序违例

#### 示例

##### 建立时间违例

$$
t_{pd}\le T_c-(t_{setup}+t_{pcg})
$$

<img src=" ../fig/ME04/ME04_chapter03_fig10.jpg" style="zoom:60%;" />

##### 保持时间违例

> 问题：竞赛条件可能导致F1的快速新令牌在F2上的旧令牌的最短保留时间之前到达F2

$$
t_{cd}\ge t_{hold}-t_{ccq}
$$

<img src=" ../fig/ME04/ME04_chapter03_fig11.jpg" style="zoom:70%;" />

#### 相关设计方法和手段

- **动态延迟评估**：仿真，激发最长通路；是比较准确的观察延迟方法，但难以实现对所有通路的观测
- **静态延迟评估**：STA工具
- **版图参数提取及后仿真** (Post sim)：提取布局布线后版图的电阻、电容寄生参数，进行更加精确的延迟计算
- **逻辑综合**：设置timing constraints，根据设计者对电路结构的了解，为延迟设定容限

#### 静态时序分析

- 时序电路中的主要延迟问题
  - 门延迟 (gate delay)是由于门转换引起的
  - 线延迟(wire delays)是由于信号沿电线传播造成的
  - 时钟偏斜(clock skew)是由于顺序元素激活的时间不同造成的
- 需要快速估算时序电路时序
  - 执行静态时序分析 (STA)
  - 假设时钟偏差可以忽略不计，请延迟到时钟网络综合之后再进行

<img src=" ../fig/ME04/ME04_chapter03_fig12.jpg" style="zoom:60%;" />

#### 时序违例小结

- 与时钟和电路延迟相关问题
- 由于布线影响延迟，所以严重依赖布线情况
- 目前的EDA工具可以通过计算评估延迟，但是近似范围，并非精确值 (可能过于保守，也可能过于乐观)
- 时序问题是在逻辑门级进行检查，而延迟计算需要物理设计 (版图)参数，效果是时序不收敛
- 解决
  - 很好地预评价通路延迟，在逻辑综合阶段留有余地
  - 很好地进行版图规划
  - 很好地利用布线资源

### 时钟偏斜/抖动

- 时钟并非总是准时到达
  - 偏斜：不同时钟元素的时钟在不同时间到达
  - 抖动：一个时钟在每个周期的不同时间到达
- 时钟性能取决于配电网（以后）

<img src=" ../fig/ME04/ME04_chapter03_fig13.jpg" style="zoom:60%;" />

#### 来自哪里

- 时钟产生
- 设备变化
- 互连变化
- 环境
- 电容耦合

#### 影响

##### 时序问题更为复杂

- 假设零时钟偏移
- 时钟确实有不确定的到达时间
  - 减少最大传播延迟
  - 增加最小污染延迟
  - 减少时间借用
- 如果违反设置时间，需要降低时钟速度
- 如果违反保持时间，芯片将在任何速度时发生故障
- 工作芯片最为重要
  - 没有工具可以分析时钟偏斜

<img src=" ../fig/ME04/ME04_chapter03_fig14.jpg" style="zoom:60%;" />

- 时钟网络的不确定性随处可见
- 影响所传送时钟的偏斜，抖动和占空比

<img src=" ../fig/ME04/ME04_chapter03_fig15.jpg" style="zoom:80%;" />
$$
t_{pd}\le T_c-(t_{setup}+t_{pcq}+t_{skew})\\
t_{cd}\ge t_{hold}-t_{ccg}+t_{skew}
$$
<img src=" ../fig/ME04/ME04_chapter03_fig16.jpg" style="zoom:80%;" />

#### 如何解决

<img src=" ../fig/ME04/ME04_chapter03_fig17.jpg" style="zoom:80%;" />

##### 时钟网络综合示例

<img src=" ../fig/ME04/ME04_chapter03_fig18.jpg" style="zoom:60%;" />

##### 时钟树

<img src=" ../fig/ME04/ME04_chapter03_fig19.jpg" style="zoom:80%;" />

<img src=" ../fig/ME04/ME04_chapter03_fig20.jpg" style="zoom:80%;" />

- 消除了由于POD引起的偏斜差异
  - 但消耗大量电能，例如网格
  - 0.18μm的IBM Power 4在时钟和锁存器中消耗70％的功率

<img src=" ../fig/ME04/ME04_chapter03_fig21.jpg" style="zoom:80%;" />

### 对于时钟话题和形象描述

- 时序的数据路径就像有交通信号灯的街道
  - 沿着街道行驶的汽车 (数据)
    - 有些车快，有些车正常行驶，有些慢
    - 主要原则：不能让两辆汽车相互碰撞
  - 当汽车 (数据)遇到信号灯 (触发器或锁存器)
    - 如果指示灯为绿色，则通过
    - 如果指示灯为红色，则等待
- 时钟系统就像信号灯的总控制者
  - 所有信号灯同时变红/变绿
    - 一些系统中信号灯短暂变绿 (触发器)
    - 在其他系统中信号灯有一半时间为绿 (锁存器)
- 信号灯的目的是让过快的车变慢
- 信号灯 (触发器或锁存器)可以通过两种方式使主要规则失败
  - 最大路径：过慢的车可能到达不了下一个街区
    - 当信号等变红时还未到达路口
  - 最小路径：过快的车可能一次穿过了多个街区
    - 当信号灯变红时，路口已清空
  - 故障通常是交通信号灯的时间安排不理想引起
    - 交通信号灯之间的差异 (偏斜)或局部变化 (抖动)
  - 解决这些故障
    - 修复最大路径：降低主控制器的速度
    - 最小路径不可行：重建街道 (或灯光控制线)
      - 3个月的制造时间和100万美元的掩模成本
  - 真的需要信号灯吗
    - 不需要，如果您可以保证所有汽车的行驶速度相同
    - 管道传输可确保所有数据路径具有相同的延迟
  - 所有的灯都需要同时开关吗
    - 不需要，长街区可能会从不同的光时序中受益
    - 芯片上故意的时钟偏移有助于解决时序问题
  - 真的需要主控制器吗
    - 不需要，如果汽车间可以进行协商
    - 数据项之间的异步电路握手

## 存储器概述

## 存储器：SRAM

## 存储器：DRAM

## 存储器：不挥发存储器

## 存储器：外围电路